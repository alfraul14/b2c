<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
    <TrustFrameworkPolicy 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
    xmlns:xsd="http://www.w3.org/2001/XMLSchema" 
    xmlns="http://schemas.microsoft.com/online/cpim/schemas/2013/06" 
    PolicySchemaVersion="0.3.0.0" TenantId="wilywonkatenant.onmicrosoft.com" 
    PolicyId="B2C_1A_ContosoCustomPolicy" PublicPolicyUri="http://wilywonkatenant.onmicrosoft.com/B2C_1A_ContosoCustomPolicy">
        <BuildingBlocks>
            <ClaimsSchema>
            <!-- donde definiremos nuestras notificaciones"claims" -->
             <ClaimType Id="givenName">
                <DisplayName>Given Name</DisplayName> 
                <!-- lo que se  va mostrar en UI -->
                <DataType>string</DataType>
                <!--tipo de dato de la notificación
                https://learn.microsoft.com/es-es/azure/active-directory-b2c/claimsschema#datatype
                -->
                <UserHelpText>Your given name (also known as first name).</UserHelpText>
                <!--ayuda al usuario de que trata-->
                <UserInputType>TextBox</UserInputType>
                <!--control de la interfaz de usuario
                https://learn.microsoft.com/es-es/azure/active-directory-b2c/claimsschema#userinputtype
                -->
            </ClaimType>
            <ClaimType Id="surname">
                <DisplayName>Surname</DisplayName>
                <DataType>string</DataType>
                <UserHelpText>Your surname (also known as family name or last name).</UserHelpText>
                <UserInputType>TextBox</UserInputType>
            </ClaimType>
            <ClaimType Id="displayName">
                <DisplayName>Display Name</DisplayName>
                <DataType>string</DataType>
                <UserHelpText>Your display name.</UserHelpText>
                <UserInputType>TextBox</UserInputType>
            </ClaimType>
            </ClaimsSchema>
            <ClaimsTransformations>
            <!-- los ClaimsTransformations nos ayudan a convertir las notificaciones que ya vienes predeterminadas
            en otras -->
                <ClaimsTransformation 
                    Id="GenerateRandomObjectIdTransformation" 
                    TransformationMethod="CreateRandomString"
                >
                <!--Contienen un identificador para identificar la transformacion dela notificación
                https://learn.microsoft.com/es-es/azure/active-directory-b2c/string-transformations
                -->
                    <InputParameters>
                        <InputParameter 
                            Id="randomGeneratorType"
                            DataType="string" 
                            Value="GUID"
                        />
                        <!--Los input parameter esperan  el valor de entrada estos dependen del TransformationMethod 
                        "CreateRandomString" que se este usando tambien el value auqneu a veces puede ser arbitrario 
                        -->
                    </InputParameters>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="objectId" TransformationClaimType="outputClaim"/>
                        <!--Los output claim contienen el tipo de notificación de salidad esperado
                        ClaimTypeReferenceId este referencia al claim ya definido.
                        TransformationClaimType tambien es definido por el método de ClaimsTransformation
                        -->
                    </OutputClaims>
                </ClaimsTransformation>

                <ClaimsTransformation Id="CreateDisplayNameTransformation" TransformationMethod="FormatStringMultipleClaims">
                    <!--este es otro tipo de método "FormatStringMultipleClaims" para dar formato a cadenas con dos parametros{0} y {1} -->
                    <InputClaims>
                    <InputClaim ClaimTypeReferenceId="givenName" TransformationClaimType="inputClaim1"/>
                    <InputClaim ClaimTypeReferenceId="surname" TransformationClaimType="inputClaim2"/>
                    <!--Los InputClaim contienen ClaimTypeReferenceId que esta definido antes en ClaimType y
                    el  TransformationClaimType es definido por el methodo de la ClaimsTransformation cada método
                     tiene sus propios valores-->
                    </InputClaims>
                    <InputParameters>
                        <InputParameter Id="stringFormat" DataType="string" Value="{0} {1}"/>
                        <!--ya vienen definidos por los ClaimsTransformation de cada método-->
                    </InputParameters>
                    <OutputClaims>
                    <OutputClaim ClaimTypeReferenceId="displayName" TransformationClaimType="outputClaim"/>
                    </OutputClaims>
                </ClaimsTransformation>

                <ClaimsTransformation Id="CreateMessageTransformation" TransformationMethod="FormatStringClaim">
                    <InputClaims>
                    <InputClaim ClaimTypeReferenceId="displayName" TransformationClaimType="inputClaim"/>
                    </InputClaims>
                    <InputParameters>
                    <InputParameter Id="stringFormat" DataType="string" Value="Hello {0}"/>
                    </InputParameters>
                    <OutputClaims>
                    <OutputClaim ClaimTypeReferenceId="message" TransformationClaimType="outputClaim"/>
                    </OutputClaims>
                </ClaimsTransformation>
            </ClaimsTransformations>
            <ContentDefinitions>
            <!--permite especificar la dirección URL a las plantillas HTML
             que controlan el diseño de las páginas web que se muestran a los usuarios.-->
                <ContentDefinition Id="SelfAssertedContentDefinition">
                    <LoadUri>~/tenant/templates/AzureBlue/selfAsserted.cshtml</LoadUri>
                    <RecoveryUri>~/common/default_page_error.html</RecoveryUri>
                    <DataUri>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:2.1.7</DataUri>
                </ContentDefinition>
            </ContentDefinitions>
        </BuildingBlocks>
        <ClaimsProviders><!--Claims Providers Here-->               
               <ClaimsProvider>
                    <DisplayName>Technical Profiles to generate claims</DisplayName>
                    <!-- es el nombre que se  va mostrar del perfil tecnico-->
                     <TechnicalProfiles>
                    <TechnicalProfile Id="ClaimGenerator">
                    <!--Es el elemnto que implementa la funcionalidad. estos perfiles tecnicos ejecutaran las definiciones 
                    anteriores como los calimType o los ClaimTransformation-->
                        <DisplayName>Generate Object ID, displayName and message Claims Technical Profile.</DisplayName>
                        <Protocol 
                            Name="Proprietary" 
                            Handler="Web.TPEngine.Providers.ClaimsTransformationProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"
                        />
                        <!--name:	Nombre de un protocolo válido admitido por Azure AD B2C que se usará como parte del perfil técnico. 
                        Los valores posibles son OAuth1, OAuth2, SAML2, OpenIdConnect, Proprietary o None.
                         handler: depende del valor de name si es propietary se debe colocar el protoclo que usara azure AD b2c-->
                        <OutputClaims>
                            <OutputClaim ClaimTypeReferenceId="objectId"/>
                            <!--OutputClaim tiene ClaimTypeReferenceId referencia a un ClaimType es el único obligatorio, defaultvalue cuando una notifiacaión no exista 
                            se usara este como valor por defecto,AlwaysUseDefaultValue obliga a usar el valor predeterminado,
                            PartnerClaimType vendría a ser el identifacdor de socio externo-->
                            <OutputClaim ClaimTypeReferenceId="displayName"/>
                            <OutputClaim ClaimTypeReferenceId="message"/>
                        </OutputClaims>
                        <OutputClaimsTransformations>
                        <!-- usan para modificar las notificaciones de salida o generar otras nuevas. Después de la ejecución, las notificaciones de salida se vuelven a 
                        poner en el contenedor de notificaciones. Puede usar esas notificaciones en el paso de orquestaciones siguiente.-->
                            <OutputClaimsTransformation ReferenceId="GenerateRandomObjectIdTransformation"/>
                            <!--Los identificadores de transformaciones de notificaciones que tienen que ejecutarse antes de enviar notificaciones
                             al proveedor de notificaciones o al usuario de confianza. Una transformación
                            de notificaciones puede usarse para modificar notificaciones ClaimsSchema existentes
                             o para generar nuevas.
                             ReferenceId Un identificador de una transformación de notificaciones 
                             que ya se ha definido en el archivo de directiva o en el archivo de directiva principal..-->
                            <OutputClaimsTransformation ReferenceId="CreateDisplayNameTransformation"/>
                            <OutputClaimsTransformation ReferenceId="CreateMessageTransformation"/>
                        </OutputClaimsTransformations>
                    </TechnicalProfile>
                </TechnicalProfiles>
                </ClaimsProvider>

                <ClaimsProvider>
                    <DisplayName>Technical Profiles to collect user's details </DisplayName>
                        <TechnicalProfiles>
                            <TechnicalProfile Id="UserInformationCollector">
                                <DisplayName>Collect User Input Technical Profile</DisplayName>
                                <!--Este perfil tecnico es denominado autoafirmado se nota la diferencia con ela nterior en el handler-->
                                <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"/>
                                <Metadata>
                                <!--Los metadatos estan relacionados con el perfil técnico
                                https://learn.microsoft.com/es-es/azure/active-directory-b2c/technicalprofiles#types-of-technical-profiles
                                en este caso se usa: ContentDefinitionReferenceId que es de Transformación de notificaciones
                                -->
                                    <Item Key="ContentDefinitionReferenceId">SelfAssertedContentDefinition</Item>
                                </Metadata>
                                <DisplayClaims>
                                <!-- es lo que se va a mostrar tiene atributos:
                                ClaimTypeReferenceId id de la notificaciión previamente definida
                                DisplayControlReferenceId id de un control de un control de visualización.
                                Required y si este es requerido o no
                                https://learn.microsoft.com/es-es/azure/active-directory-b2c/technicalprofiles
                                	-->
                                    <DisplayClaim ClaimTypeReferenceId="givenName" Required="true"/>
                                    <DisplayClaim ClaimTypeReferenceId="surname" Required="true"/>
                                </DisplayClaims>
                                <OutputClaims>
                                    <OutputClaim ClaimTypeReferenceId="givenName"/>
                                    <OutputClaim ClaimTypeReferenceId="surname"/>
                                </OutputClaims>
                            </TechnicalProfile>
                        </TechnicalProfiles>
                </ClaimsProvider>
         </ClaimsProviders>
            

    </TrustFrameworkPolicy>